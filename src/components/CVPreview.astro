---
import { readFileSync } from 'fs';
import { join } from 'path';

let cvContent = '';
try {
	// Use process.cwd() to get project root, then build path to CV file
	const cvPath = join(process.cwd(), 'src/content/cv/cv.md');
	console.log('[CVPreview] Reading CV from:', cvPath);
	cvContent = readFileSync(cvPath, 'utf-8');
	console.log('[CVPreview] Successfully read CV, length:', cvContent.length);
} catch (e) {
	console.error('[CVPreview] Error reading CV file:', e);
	cvContent = 'CV content not available';
}

// Convert markdown to HTML (simple conversion)
function markdownToHtml(md: string): string {
	let html = md;
	
	// Process line by line to handle structure better
	const lines = html.split('\n');
	const result: string[] = [];
	let inList = false;
	
	for (let i = 0; i < lines.length; i++) {
		const line = lines[i].trim();
		
		if (!line) {
			if (inList) {
				result.push('</ul>');
				inList = false;
			}
			continue;
		}
		
		// Headers
		if (line.startsWith('### ')) {
			if (inList) {
				result.push('</ul>');
				inList = false;
			}
			result.push(`<h3>${line.substring(4)}</h3>`);
		} else if (line.startsWith('## ')) {
			if (inList) {
				result.push('</ul>');
				inList = false;
			}
			result.push(`<h2>${line.substring(3)}</h2>`);
		} else if (line.startsWith('# ')) {
			if (inList) {
				result.push('</ul>');
				inList = false;
			}
			result.push(`<h1>${line.substring(2)}</h1>`);
		}
		// Lists
		else if (line.startsWith('- ')) {
			if (!inList) {
				result.push('<ul>');
				inList = true;
			}
			let listItem = line.substring(2);
			// Process bold and links in list items
			listItem = listItem.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
			listItem = listItem.replace(/<https?:\/\/[^>]+>/g, (match) => {
				const url = match.slice(1, -1);
				return `<a href="${url}" target="_blank" rel="noreferrer">${url}</a>`;
			});
			result.push(`<li>${listItem}</li>`);
		}
		// Regular paragraphs
		else {
			if (inList) {
				result.push('</ul>');
				inList = false;
			}
			let para = line;
			// Process bold
			para = para.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
			// Process links
			para = para.replace(/<https?:\/\/[^>]+>/g, (match) => {
				const url = match.slice(1, -1);
				return `<a href="${url}" target="_blank" rel="noreferrer">${url}</a>`;
			});
			result.push(`<p>${para}</p>`);
		}
	}
	
	if (inList) {
		result.push('</ul>');
	}
	
	return result.join('\n');
}

const cvHtml = markdownToHtml(cvContent);
---

<div id="cv-modal" class="cv-modal" role="dialog" aria-modal="true" aria-labelledby="cv-modal-title" aria-hidden="true">
	<div class="cv-modal-overlay" id="cv-modal-overlay"></div>
	<div class="cv-modal-content">
		<div class="cv-modal-header">
			<h2 id="cv-modal-title">CV Preview</h2>
			<button class="cv-modal-close" id="cv-modal-close" aria-label="Close CV preview">
				<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</button>
		</div>
		<div class="cv-modal-body">
			<div class="cv-content" set:html={cvHtml} />
		</div>
	</div>
</div>

<script>
	const modal = document.getElementById('cv-modal');
	const overlay = document.getElementById('cv-modal-overlay');
	const closeBtn = document.getElementById('cv-modal-close');
	
	function openModal() {
		if (modal) {
			modal.setAttribute('aria-hidden', 'false');
			modal.classList.add('open');
			document.body.style.overflow = 'hidden';
		}
	}
	
	function closeModal() {
		if (modal) {
			modal.setAttribute('aria-hidden', 'true');
			modal.classList.remove('open');
			document.body.style.overflow = '';
		}
	}
	
	overlay?.addEventListener('click', closeModal);
	closeBtn?.addEventListener('click', closeModal);
	
	// Close on Escape key
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && modal?.classList.contains('open')) {
			closeModal();
		}
	});
	
	// Export function to open modal
	(window as any).openCVPreview = openModal;
</script>

<style>
	.cv-modal {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		z-index: 10000;
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease, visibility 0.3s ease;
	}
	
	.cv-modal.open {
		opacity: 1;
		visibility: visible;
	}
	
	.cv-modal-overlay {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.7);
		backdrop-filter: blur(4px);
	}
	
	.cv-modal-content {
		position: relative;
		width: 90%;
		max-width: 900px;
		max-height: 90vh;
		background: var(--bg-primary);
		border-radius: 16px;
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
		display: flex;
		flex-direction: column;
		overflow: hidden;
		transform: scale(0.9);
		transition: transform 0.3s ease;
	}
	
	.cv-modal.open .cv-modal-content {
		transform: scale(1);
	}
	
	.cv-modal-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 1.5rem 2rem;
		border-bottom: 1px solid var(--border-color);
		background: var(--bg-secondary);
	}
	
	.cv-modal-header h2 {
		margin: 0;
		font-size: 1.5rem;
		color: var(--text-primary);
	}
	
	.cv-modal-close {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 40px;
		height: 40px;
		padding: 0;
		background: transparent;
		border: 1px solid var(--border-color);
		border-radius: 8px;
		cursor: pointer;
		color: var(--text-primary);
		transition: all 0.2s ease;
	}
	
	.cv-modal-close:hover {
		background: var(--bg-primary);
		border-color: var(--accent);
		color: var(--accent);
	}
	
	.cv-modal-body {
		flex: 1;
		overflow-y: auto;
		padding: 2rem;
	}
	
	.cv-content {
		color: var(--text-primary);
		line-height: 1.8;
	}
	
	.cv-content h1 {
		font-size: 2rem;
		margin: 0 0 1rem;
		color: var(--text-primary);
		border-bottom: 2px solid var(--accent);
		padding-bottom: 0.5rem;
	}
	
	.cv-content h2 {
		font-size: 1.5rem;
		margin: 2rem 0 1rem;
		color: var(--text-primary);
	}
	
	.cv-content h3 {
		font-size: 1.25rem;
		margin: 1.5rem 0 0.75rem;
		color: var(--text-primary);
	}
	
	.cv-content p {
		margin: 0.75rem 0;
		color: var(--text-secondary);
	}
	
	.cv-content ul {
		margin: 1rem 0;
		padding-left: 1.5rem;
	}
	
	.cv-content li {
		margin: 0.5rem 0;
		color: var(--text-secondary);
	}
	
	.cv-content a {
		color: var(--accent);
		text-decoration: none;
	}
	
	.cv-content a:hover {
		text-decoration: underline;
	}
	
	.cv-content strong {
		color: var(--text-primary);
		font-weight: 600;
	}
	
	@media (max-width: 720px) {
		.cv-modal-content {
			width: 95%;
			max-height: 95vh;
		}
		
		.cv-modal-header {
			padding: 1rem 1.5rem;
		}
		
		.cv-modal-body {
			padding: 1.5rem;
		}
		
		.cv-content h1 {
			font-size: 1.5rem;
		}
		
		.cv-content h2 {
			font-size: 1.25rem;
		}
	}
</style>
