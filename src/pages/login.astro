---
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Login">
	<section class="page-header">
		<div>
			<p class="eyebrow">Welcome back</p>
			<h1>Login</h1>
			<p class="lead">Login with admin account to manage blog.</p>
		</div>
	</section>

	<section class="login-section">
		<!-- Login Form (hidden when logged in) -->
		<form id="admin-login-form" class="card">
			<div class="field-group">
				<label for="username">Username</label>
				<input
					id="username"
					name="username"
					type="text"
					required
					placeholder="Enter your username"
					autocomplete="username"
				/>
			</div>
			<div class="field-group">
				<label for="password">Password</label>
				<input
					id="password"
					name="password"
					type="password"
					required
					placeholder="Enter your password"
					autocomplete="current-password"
				/>
			</div>
			<div class="actions">
				<button type="submit" class="primary-btn">
					<span>Login</span>
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M5 12h14M12 5l7 7-7 7"/>
					</svg>
				</button>
			</div>
			<div class="divider">
				<span>or</span>
			</div>
			<div id="google-signin-button"></div>
			<p id="login-message" class="message" aria-live="polite" hidden></p>
		</form>

		<!-- User Profile (shown when logged in) -->
		<div id="user-profile" class="card user-card" hidden>
			<div class="user-header">
				<div class="user-avatar">
					<img id="user-avatar-img" src="" alt="User avatar" hidden />
					<div id="user-avatar-placeholder" class="avatar-placeholder">
						<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
							<circle cx="12" cy="7" r="4"/>
						</svg>
					</div>
				</div>
				<div class="user-info">
					<h2 id="user-name" class="user-name"></h2>
					<p id="user-email" class="user-email"></p>
					<span id="login-method" class="login-method-badge"></span>
				</div>
			</div>
			<div class="user-actions">
				<button type="button" id="logout-button" class="logout-btn">
					<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
						<polyline points="16 17 21 12 16 7"/>
						<line x1="21" y1="12" x2="9" y2="12"/>
					</svg>
					<span>Logout</span>
				</button>
			</div>
		</div>
	</section>

	<script>
		// Type definitions for Google Identity Services
		interface GoogleAccounts {
			accounts: {
				id: {
					initialize: (config: { client_id: string; callback: (response: any) => void }) => void;
					renderButton: (element: HTMLElement | null, config: any) => void;
					disableAutoSelect: () => void;
				};
			};
		}
		
		declare global {
			interface Window {
				google?: GoogleAccounts;
			}
		}

		// Google OAuth Configuration
		// TODO: Replace with your Google Client ID from Google Cloud Console
		// https://console.cloud.google.com/apis/credentials
		const GOOGLE_CLIENT_ID = import.meta.env.PUBLIC_GOOGLE_CLIENT_ID || '117700101080-9471bgmhfqskapsr1ttmej2u8abt6i0v.apps.googleusercontent.com';
		
		const FORM_ID = 'admin-login-form';
		const USERNAME_INPUT_ID = 'username';
		const PASSWORD_INPUT_ID = 'password';
		const MESSAGE_ID = 'login-message';
		const LOGOUT_BUTTON_ID = 'logout-button';
		const STORAGE_KEY = 'adminLoggedIn';
		const GOOGLE_USER_KEY = 'googleUser';

		const form = document.getElementById(FORM_ID) as HTMLFormElement | null;
		const userProfile = document.getElementById('user-profile') as HTMLDivElement | null;
		const usernameInput = document.getElementById(
			USERNAME_INPUT_ID,
		) as HTMLInputElement | null;
		const passwordInput = document.getElementById(
			PASSWORD_INPUT_ID,
		) as HTMLInputElement | null;
		const messageEl = document.getElementById(MESSAGE_ID) as HTMLParagraphElement | null;
		const logoutBtn = document.getElementById(
			LOGOUT_BUTTON_ID,
		) as HTMLButtonElement | null;
		const userNameEl = document.getElementById('user-name') as HTMLHeadingElement | null;
		const userEmailEl = document.getElementById('user-email') as HTMLParagraphElement | null;
		const userAvatarImg = document.getElementById('user-avatar-img') as HTMLImageElement | null;
		const userAvatarPlaceholder = document.getElementById('user-avatar-placeholder') as HTMLDivElement | null;
		const loginMethodEl = document.getElementById('login-method') as HTMLSpanElement | null;

		// Check if should initialize Google Sign-In
		const shouldInitGoogle = () => {
			const isLoggedIn = window.localStorage.getItem(STORAGE_KEY) === 'true';
			const googleUser = window.localStorage.getItem(GOOGLE_USER_KEY);
			return !isLoggedIn && !googleUser;
		};

		// Show user profile
		function showUserProfile() {
			const googleUserStr = window.localStorage.getItem(GOOGLE_USER_KEY);
			const isGoogleLogin = !!googleUserStr;
			
			// Hide login form, show user profile
			if (form) {
				form.hidden = true;
				form.style.display = 'none';
			}
			if (userProfile) {
				userProfile.hidden = false;
				userProfile.style.display = 'block';
			}
			
			// Clear Google button if exists
			const googleButtonEl = document.getElementById('google-signin-button');
			if (googleButtonEl) {
				googleButtonEl.innerHTML = '';
			}
			
			if (isGoogleLogin && googleUserStr) {
				try {
					const googleUser = JSON.parse(googleUserStr);
					if (userNameEl) userNameEl.textContent = googleUser.name || 'User';
					if (userEmailEl) userEmailEl.textContent = googleUser.email || '';
					if (loginMethodEl) {
						loginMethodEl.textContent = 'Google Account';
						loginMethodEl.classList.add('google-badge');
					}
					if (googleUser.picture && userAvatarImg && userAvatarPlaceholder) {
						userAvatarImg.src = googleUser.picture;
						userAvatarImg.hidden = false;
						userAvatarPlaceholder.hidden = true;
					}
				} catch (e) {
					console.error('Error parsing Google user:', e);
				}
			} else {
				// Admin login
				if (userNameEl) userNameEl.textContent = 'Admin';
				if (userEmailEl) userEmailEl.textContent = 'Administrator Account';
				if (loginMethodEl) {
					loginMethodEl.textContent = 'Admin Account';
					loginMethodEl.classList.add('admin-badge');
				}
				if (userAvatarPlaceholder) userAvatarPlaceholder.hidden = false;
				if (userAvatarImg) userAvatarImg.hidden = true;
			}
		}

		// Check if already logged in
		function checkLoginStatus() {
			const isLoggedIn = window.localStorage.getItem(STORAGE_KEY) === 'true';
			const googleUser = window.localStorage.getItem(GOOGLE_USER_KEY);
			
			if (isLoggedIn || googleUser) {
				showUserProfile();
			} else {
				// Show login form, hide user profile
				if (form) {
					form.hidden = false;
					form.style.display = 'block';
				}
				if (userProfile) {
					userProfile.hidden = true;
					userProfile.style.display = 'none';
				}
				if (messageEl) {
					messageEl.hidden = true;
					messageEl.textContent = '';
				}
				
				// Re-initialize Google Sign-In if needed
				if (shouldInitGoogle()) {
					initializeGoogleSignIn();
				}
			}
		}

		// Initialize on page load
		checkLoginStatus();

		// Google Sign-In initialization
		function initializeGoogleSignIn() {
			if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
				console.warn('Google Client ID not configured. Please set PUBLIC_GOOGLE_CLIENT_ID in .env');
				return;
			}

			// Load Google Identity Services script
			const script = document.createElement('script');
			script.src = 'https://accounts.google.com/gsi/client';
			script.async = true;
			script.defer = true;
			script.onload = () => {
				// Only render Google button if user is not logged in
				const isLoggedIn = window.localStorage.getItem(STORAGE_KEY) === 'true';
				const googleUser = window.localStorage.getItem(GOOGLE_USER_KEY);
				
				if (!isLoggedIn && !googleUser && window.google?.accounts?.id) {
					window.google.accounts.id.initialize({
						client_id: GOOGLE_CLIENT_ID,
						callback: handleGoogleSignIn,
					});

					const googleButtonEl = document.getElementById('google-signin-button');
					if (googleButtonEl) {
						window.google.accounts.id.renderButton(
							googleButtonEl,
							{
								theme: 'outline',
								size: 'large',
								width: '100%',
								text: 'signin_with',
								locale: 'en',
							}
						);
					}
				}
			};
			document.head.appendChild(script);
		}

		// Handle Google Sign-In callback
		function handleGoogleSignIn(response: any) {
			try {
				// Decode JWT token (basic decode, in production verify with backend)
				const payload = JSON.parse(atob(response.credential.split('.')[1]));
				
				// Store user info
				const userInfo = {
					email: payload.email,
					name: payload.name,
					picture: payload.picture,
					sub: payload.sub,
				};
				
				window.localStorage.setItem(GOOGLE_USER_KEY, JSON.stringify(userInfo));
				window.localStorage.setItem(STORAGE_KEY, 'true');
				
				showUserProfile();
			} catch (error) {
				console.error('Error processing Google sign-in:', error);
				if (messageEl) {
					messageEl.textContent = 'Error signing in with Google. Please try again.';
					messageEl.classList.remove('success');
					messageEl.classList.add('error');
					messageEl.hidden = false;
				}
			}
		}

		// Initialize Google Sign-In when DOM is ready (only if not logged in)
		if (shouldInitGoogle()) {
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initializeGoogleSignIn);
			} else {
				initializeGoogleSignIn();
			}
		}

		// Traditional form login
		form?.addEventListener('submit', (event) => {
			event.preventDefault();

			const username = usernameInput?.value.trim() ?? '';
			const password = passwordInput?.value ?? '';

			// Demo: tài khoản tĩnh ở client
			const VALID_USERNAME = 'admin';
			const VALID_PASSWORD = '1';

			if (username === VALID_USERNAME && password === VALID_PASSWORD) {
				window.localStorage.setItem(STORAGE_KEY, 'true');
				window.localStorage.removeItem(GOOGLE_USER_KEY); // Clear Google user if exists
				showUserProfile();
			} else {
				if (messageEl) {
					messageEl.textContent = 'Incorrect username or password. Please try again.';
					messageEl.classList.remove('success');
					messageEl.classList.add('error');
					messageEl.hidden = false;
				}
			}
		});

		// Logout handler
		logoutBtn?.addEventListener('click', () => {
			window.localStorage.removeItem(STORAGE_KEY);
			window.localStorage.removeItem(GOOGLE_USER_KEY);
			
			// Sign out from Google if logged in via Google
			if (window.google?.accounts?.id) {
				window.google.accounts.id.disableAutoSelect();
			}
			
			// Show login form, hide user profile
			if (form) {
				form.hidden = false;
				form.style.display = 'block';
			}
			if (userProfile) {
				userProfile.hidden = true;
				userProfile.style.display = 'none';
			}
			if (messageEl) {
				messageEl.hidden = true;
				messageEl.textContent = '';
			}
			if (usernameInput) usernameInput.value = '';
			if (passwordInput) passwordInput.value = '';
			
			// Re-initialize Google Sign-In button
			if (shouldInitGoogle()) {
				// Clear existing button and re-init
				const googleButtonEl = document.getElementById('google-signin-button');
				if (googleButtonEl) {
					googleButtonEl.innerHTML = '';
				}
				initializeGoogleSignIn();
			}
		});
	</script>

	<style>
		.page-header {
			display: grid;
			gap: 0.5rem;
			margin-bottom: 2rem;
			text-align: center;
		}
		.eyebrow {
			margin: 0;
			text-transform: uppercase;
			font-size: 0.9rem;
			letter-spacing: 0.15em;
			color: rgb(var(--gray));
		}
		.lead {
			margin: 0;
			color: rgb(var(--gray));
			max-width: 640px;
			margin-left: auto;
			margin-right: auto;
		}
		.login-section {
			display: flex;
			justify-content: center;
			align-items: flex-start;
		}
		#admin-login-form[hidden],
		#user-profile[hidden] {
			display: none !important;
			visibility: hidden !important;
		}
		#admin-login-form:not([hidden]),
		#user-profile:not([hidden]) {
			display: block;
		}
		.card {
			display: grid;
			gap: 1rem;
			width: 100%;
			max-width: 400px;
			padding: 2rem;
			border-radius: 1rem;
			border: 1px solid var(--border-color);
			box-shadow: 0 10px 25px rgba(var(--black), 0.04);
			background: var(--bg-primary);
			transition: background-color 0.3s ease, border-color 0.3s ease;
		}
		.actions {
			display: flex;
			gap: 0.5rem;
			align-items: center;
			flex-wrap: wrap;
		}
		.primary-btn {
			flex: 1;
			min-width: 120px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			padding: 0.75rem 1.5rem;
			border-radius: 999px;
			border: none;
			background: linear-gradient(135deg, rgb(var(--accent)) 0%, var(--accent-dark) 100%);
			color: white;
			font-weight: 600;
			font-size: 1rem;
			cursor: pointer;
			box-shadow: 0 4px 12px rgba(var(--accent-rgb), 0.3);
			transition: all 0.2s ease;
		}
		.primary-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(var(--accent-rgb), 0.4);
			filter: brightness(1.05);
		}
		.primary-btn:active {
			transform: translateY(0);
		}
		.primary-btn svg {
			transition: transform 0.2s ease;
		}
		.primary-btn:hover svg {
			transform: translateX(2px);
		}
		.field-group {
			display: grid;
			gap: 0.25rem;
		}
		label {
			font-weight: 500;
			font-size: 0.95rem;
		}
		input {
			padding: 0.6rem 0.75rem;
			border-radius: 0.6rem;
			border: 1px solid var(--border-color);
			background: var(--bg-primary);
			color: var(--text-primary);
			font-size: 1rem;
			transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
		}
		input:focus-visible {
			outline: 2px solid rgb(var(--accent));
			outline-offset: 1px;
		}
		.secondary-btn {
			margin-top: 0.25rem;
			padding: 0.6rem 0.9rem;
			border-radius: 999px;
			border: 1px solid var(--border-color);
			background: var(--bg-primary);
			color: var(--text-primary);
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
		}
		.secondary-btn:hover {
			background: var(--bg-secondary);
		}
		.message {
			min-height: 1.4rem;
			font-size: 0.9rem;
			margin-top: 0.5rem;
		}
		.message[hidden] {
			display: none;
		}
		.message.error {
			color: #dc2626;
		}
		.message.success {
			color: #16a34a;
		}
		.divider {
			display: flex;
			align-items: center;
			text-align: center;
			margin: 1rem 0;
		}
		.divider::before,
		.divider::after {
			content: '';
			flex: 1;
			border-bottom: 1px solid var(--border-color);
		}
		.divider span {
			padding: 0 1rem;
			color: rgb(var(--gray));
			font-size: 0.9rem;
		}
		#google-signin-button {
			display: flex;
			justify-content: center;
		}

		/* User Profile Styles */
		.user-card {
			max-width: 500px;
		}
		.user-header {
			display: flex;
			align-items: center;
			gap: 1.25rem;
			padding-bottom: 1.5rem;
			border-bottom: 1px solid var(--border-color);
		}
		.user-avatar {
			flex-shrink: 0;
			width: 80px;
			height: 80px;
			border-radius: 50%;
			overflow: hidden;
			background: var(--bg-secondary);
			border: 3px solid var(--border-color);
		}
		.user-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
		.avatar-placeholder {
			width: 100%;
			height: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
			color: rgb(var(--gray));
			background: var(--bg-secondary);
		}
		.user-info {
			flex: 1;
			min-width: 0;
		}
		.user-name {
			margin: 0 0 0.25rem 0;
			font-size: 1.5rem;
			font-weight: 700;
			color: var(--text-primary);
		}
		.user-email {
			margin: 0 0 0.5rem 0;
			font-size: 0.95rem;
			color: rgb(var(--gray));
		}
		.login-method-badge {
			display: inline-block;
			padding: 0.25rem 0.75rem;
			border-radius: 999px;
			font-size: 0.8rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.05em;
		}
		.login-method-badge.google-badge {
			background: rgba(66, 133, 244, 0.1);
			color: #4285f4;
		}
		.login-method-badge.admin-badge {
			background: rgba(var(--accent-rgb), 0.1);
			color: rgb(var(--accent));
		}
		.user-actions {
			margin-top: 1.5rem;
		}
		.logout-btn {
			width: 100%;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			padding: 0.75rem 1.5rem;
			border-radius: 999px;
			border: 1px solid var(--border-color);
			background: var(--bg-primary);
			color: var(--text-primary);
			font-weight: 600;
			font-size: 1rem;
			cursor: pointer;
			transition: all 0.2s ease;
		}
		.logout-btn:hover {
			background: var(--bg-secondary);
			border-color: #dc2626;
			color: #dc2626;
			transform: translateY(-1px);
		}
		.logout-btn:active {
			transform: translateY(0);
		}
		
		@media (max-width: 640px) {
			.card {
				padding: 1.5rem;
			}
			.page-header {
				margin-bottom: 1.5rem;
			}
			.user-header {
				flex-direction: column;
				text-align: center;
			}
			.user-avatar {
				width: 100px;
				height: 100px;
			}
		}
	</style>
</PageLayout>

