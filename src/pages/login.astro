---
import PageLayout from '../layouts/PageLayout.astro';
---

<PageLayout title="Login">
	<section class="page-header">
		<div>
			<p class="eyebrow">Welcome back</p>
			<h1>Login</h1>
			<p class="lead">Login with admin account to manage blog.</p>
		</div>
	</section>

	<section>
		<form id="admin-login-form" class="card">
			<div class="field-group">
				<label for="username">Username</label>
				<input
					id="username"
					name="username"
					type="text"
					required
					placeholder="e.g., admin"
					autocomplete="username"
				/>
			</div>
			<div class="field-group">
				<label for="password">Password</label>
				<input
					id="password"
					name="password"
					type="password"
					required
					placeholder="Enter password"
					autocomplete="current-password"
				/>
			</div>
			<div class="actions">
				<button type="submit" class="primary-btn">Login</button>
				<button type="button" id="logout-button" class="secondary-btn" hidden>
					Logout
				</button>
			</div>
			<div class="divider">
				<span>or</span>
			</div>
			<div id="google-signin-button"></div>
			<p id="login-message" class="message" aria-live="polite"></p>
			<p class="hint">
				<b>Demo account</b>: <code>admin</code> / <code>1</code>
			</p>
		</form>
	</section>

	<script>
		// Type definitions for Google Identity Services
		interface GoogleAccounts {
			accounts: {
				id: {
					initialize: (config: { client_id: string; callback: (response: any) => void }) => void;
					renderButton: (element: HTMLElement | null, config: any) => void;
					disableAutoSelect: () => void;
				};
			};
		}
		
		declare global {
			interface Window {
				google?: GoogleAccounts;
			}
		}

		// Google OAuth Configuration
		// TODO: Replace with your Google Client ID from Google Cloud Console
		// https://console.cloud.google.com/apis/credentials
		const GOOGLE_CLIENT_ID = import.meta.env.PUBLIC_GOOGLE_CLIENT_ID || '117700101080-9471bgmhfqskapsr1ttmej2u8abt6i0v.apps.googleusercontent.com';
		
		const FORM_ID = 'admin-login-form';
		const USERNAME_INPUT_ID = 'username';
		const PASSWORD_INPUT_ID = 'password';
		const MESSAGE_ID = 'login-message';
		const LOGOUT_BUTTON_ID = 'logout-button';
		const STORAGE_KEY = 'adminLoggedIn';
		const GOOGLE_USER_KEY = 'googleUser';

		const form = document.getElementById(FORM_ID) as HTMLFormElement | null;
		const usernameInput = document.getElementById(
			USERNAME_INPUT_ID,
		) as HTMLInputElement | null;
		const passwordInput = document.getElementById(
			PASSWORD_INPUT_ID,
		) as HTMLInputElement | null;
		const messageEl = document.getElementById(MESSAGE_ID) as HTMLParagraphElement | null;
		const logoutBtn = document.getElementById(
			LOGOUT_BUTTON_ID,
		) as HTMLButtonElement | null;

		// Check if already logged in
		function checkLoginStatus() {
			const isLoggedIn = window.localStorage.getItem(STORAGE_KEY) === 'true';
			const googleUser = window.localStorage.getItem(GOOGLE_USER_KEY);
			
			if (isLoggedIn || googleUser) {
				if (messageEl) {
					const loginMethod = googleUser ? 'Google' : 'admin';
					messageEl.textContent = `You are logged in via ${loginMethod}.`;
					messageEl.classList.remove('error');
					messageEl.classList.add('success');
				}
				if (logoutBtn) {
					logoutBtn.hidden = false;
				}
			}
		}

		// Initialize on page load
		checkLoginStatus();

		// Google Sign-In initialization
		function initializeGoogleSignIn() {
			if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
				console.warn('Google Client ID not configured. Please set PUBLIC_GOOGLE_CLIENT_ID in .env');
				return;
			}

			// Load Google Identity Services script
			const script = document.createElement('script');
			script.src = 'https://accounts.google.com/gsi/client';
			script.async = true;
			script.defer = true;
			script.onload = () => {
				if (window.google?.accounts?.id) {
					window.google.accounts.id.initialize({
						client_id: GOOGLE_CLIENT_ID,
						callback: handleGoogleSignIn,
					});

					window.google.accounts.id.renderButton(
						document.getElementById('google-signin-button'),
						{
							theme: 'outline',
							size: 'large',
							width: '100%',
							text: 'signin_with',
							locale: 'en',
						}
					);
				}
			};
			document.head.appendChild(script);
		}

		// Handle Google Sign-In callback
		function handleGoogleSignIn(response: any) {
			try {
				// Decode JWT token (basic decode, in production verify with backend)
				const payload = JSON.parse(atob(response.credential.split('.')[1]));
				
				// Store user info
				const userInfo = {
					email: payload.email,
					name: payload.name,
					picture: payload.picture,
					sub: payload.sub,
				};
				
				window.localStorage.setItem(GOOGLE_USER_KEY, JSON.stringify(userInfo));
				window.localStorage.setItem(STORAGE_KEY, 'true');
				
				if (messageEl) {
					messageEl.textContent = `Login successful! Welcome, ${userInfo.name || userInfo.email}.`;
					messageEl.classList.remove('error');
					messageEl.classList.add('success');
				}
				
				if (logoutBtn) {
					logoutBtn.hidden = false;
				}
			} catch (error) {
				console.error('Error processing Google sign-in:', error);
				if (messageEl) {
					messageEl.textContent = 'Error signing in with Google. Please try again.';
					messageEl.classList.remove('success');
					messageEl.classList.add('error');
				}
			}
		}

		// Initialize Google Sign-In when DOM is ready
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initializeGoogleSignIn);
		} else {
			initializeGoogleSignIn();
		}

		// Traditional form login
		form?.addEventListener('submit', (event) => {
			event.preventDefault();

			const username = usernameInput?.value.trim() ?? '';
			const password = passwordInput?.value ?? '';

			// Demo: tài khoản tĩnh ở client
			const VALID_USERNAME = 'admin';
			const VALID_PASSWORD = '1';

			if (username === VALID_USERNAME && password === VALID_PASSWORD) {
				window.localStorage.setItem(STORAGE_KEY, 'true');
				window.localStorage.removeItem(GOOGLE_USER_KEY); // Clear Google user if exists
				if (messageEl) {
					messageEl.textContent = 'Login successful. You are now admin.';
					messageEl.classList.remove('error');
					messageEl.classList.add('success');
				}
				if (logoutBtn) {
					logoutBtn.hidden = false;
				}
			} else {
				if (messageEl) {
					messageEl.textContent = 'Incorrect username or password. Please try again.';
					messageEl.classList.remove('success');
					messageEl.classList.add('error');
				}
			}
		});

		// Logout handler
		logoutBtn?.addEventListener('click', () => {
			window.localStorage.removeItem(STORAGE_KEY);
			window.localStorage.removeItem(GOOGLE_USER_KEY);
			
			// Sign out from Google if logged in via Google
			if (window.google?.accounts?.id) {
				window.google.accounts.id.disableAutoSelect();
			}
			
			if (messageEl) {
				messageEl.textContent = 'You have logged out.';
				messageEl.classList.remove('success');
				messageEl.classList.remove('error');
			}
			if (logoutBtn) {
				logoutBtn.hidden = true;
			}
			if (usernameInput) usernameInput.value = '';
			if (passwordInput) passwordInput.value = '';
		});
	</script>

	<style>
		.page-header {
			display: grid;
			gap: 0.5rem;
			margin-bottom: 1.5rem;
		}
		.eyebrow {
			margin: 0;
			text-transform: uppercase;
			font-size: 0.9rem;
			letter-spacing: 0.15em;
			color: rgb(var(--gray));
		}
		.lead {
			margin: 0;
			color: rgb(var(--gray));
			max-width: 640px;
		}
		.card {
			display: grid;
			gap: 0.75rem;
			max-width: 380px;
			padding: 1.5rem 1.75rem;
			border-radius: 1rem;
			border: 1px solid var(--border-color);
			box-shadow: 0 10px 25px rgba(var(--black), 0.04);
			background: var(--bg-primary);
			transition: background-color 0.3s ease, border-color 0.3s ease;
		}
		.actions {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		.field-group {
			display: grid;
			gap: 0.25rem;
		}
		label {
			font-weight: 500;
			font-size: 0.95rem;
		}
		input {
			padding: 0.6rem 0.75rem;
			border-radius: 0.6rem;
			border: 1px solid var(--border-color);
			background: var(--bg-primary);
			color: var(--text-primary);
			font-size: 1rem;
			transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
		}
		input:focus-visible {
			outline: 2px solid rgb(var(--accent));
			outline-offset: 1px;
		}
		.primary-btn {
			margin-top: 0.25rem;
			padding: 0.6rem 0.9rem;
			border-radius: 999px;
			border: none;
			background: rgb(var(--accent));
			color: white;
			font-weight: 600;
			cursor: pointer;
		}
		.primary-btn:hover {
			filter: brightness(0.95);
		}
		.secondary-btn {
			margin-top: 0.25rem;
			padding: 0.6rem 0.9rem;
			border-radius: 999px;
			border: 1px solid var(--border-color);
			background: var(--bg-primary);
			color: var(--text-primary);
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
		}
		.secondary-btn:hover {
			background: var(--bg-secondary);
		}
		.message {
			min-height: 1.4rem;
			font-size: 0.9rem;
		}
		.message.error {
			color: #dc2626;
		}
		.message.success {
			color: #16a34a;
		}
		.hint {
			margin-top: 0.5rem;
			font-size: 0.85rem;
			color: rgb(var(--gray));
			max-width: 480px;
		}
		.divider {
			display: flex;
			align-items: center;
			text-align: center;
			margin: 1rem 0;
		}
		.divider::before,
		.divider::after {
			content: '';
			flex: 1;
			border-bottom: 1px solid var(--border-color);
		}
		.divider span {
			padding: 0 1rem;
			color: rgb(var(--gray));
			font-size: 0.9rem;
		}
		#google-signin-button {
			display: flex;
			justify-content: center;
			margin-top: 0.5rem;
		}
	</style>
</PageLayout>

