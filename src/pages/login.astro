---
export const prerender = false; // Disable prerendering to support i18n cookies

import PageLayout from '../layouts/PageLayout.astro';
import { getCurrentLanguage, t } from '../i18n/utils';

const lang = getCurrentLanguage(Astro);
const title = t('login.title', lang);
---

<PageLayout title={title}>
	<section class="page-header">
		<div>
			<p class="eyebrow">{t('login.eyebrow', lang)}</p>
			<h1>{t('login.title', lang)}</h1>
			<p class="lead">{t('login.description', lang)}</p>
		</div>
	</section>

	<section>
		<form id="admin-login-form" class="card">
			<div class="field-group">
				<label for="username">{t('login.username', lang)}</label>
				<input
					id="username"
					name="username"
					type="text"
					required
					placeholder={t('login.usernamePlaceholder', lang)}
					autocomplete="username"
				/>
			</div>
			<div class="field-group">
				<label for="password">{t('login.password', lang)}</label>
				<input
					id="password"
					name="password"
					type="password"
					required
					placeholder={t('login.passwordPlaceholder', lang)}
					autocomplete="current-password"
				/>
			</div>
			<div class="actions">
				<button type="submit" class="primary-btn">{t('login.submit', lang)}</button>
				<button type="button" id="logout-button" class="secondary-btn" hidden>
					{t('login.logout', lang)}
				</button>
			</div>
			<p id="login-message" class="message" aria-live="polite"></p>
			<p class="hint">
				<b>{t('login.demoAccount', lang)}</b>: <code>admin</code> / <code>1</code>
			</p>
		</form>
	</section>

	<script>
		const FORM_ID = 'admin-login-form';
		const USERNAME_INPUT_ID = 'username';
		const PASSWORD_INPUT_ID = 'password';
		const MESSAGE_ID = 'login-message';
		const LOGOUT_BUTTON_ID = 'logout-button';
		const STORAGE_KEY = 'adminLoggedIn';
		const LANG_STORAGE_KEY = 'selectedLanguage';
		
		// Get current language
		function getLang() {
			return localStorage.getItem(LANG_STORAGE_KEY) || 'en';
		}
		
		// Translations for messages
		const messages = {
			en: {
				loggedIn: 'You are logged in as admin.',
				success: 'Login successful. You are now admin.',
				error: 'Incorrect username or password. Please try again.',
				loggedOut: 'You have logged out.',
			},
			zh: {
				loggedIn: '您已以管理员身份登录。',
				success: '登录成功。您现在是一名管理员。',
				error: '用户名或密码错误。请重试。',
				loggedOut: '您已登出。',
			},
			vi: {
				loggedIn: 'Bạn đang đăng nhập với quyền admin.',
				success: 'Đăng nhập thành công. Bạn đang là admin.',
				error: 'Sai tài khoản hoặc mật khẩu. Vui lòng thử lại.',
				loggedOut: 'Bạn đã đăng xuất.',
			},
		};
		
		function getMessage(key) {
			const lang = getLang();
			return messages[lang]?.[key] || messages.en[key];
		}

		const form = document.getElementById(FORM_ID) as HTMLFormElement | null;
		const usernameInput = document.getElementById(
			USERNAME_INPUT_ID,
		) as HTMLInputElement | null;
		const passwordInput = document.getElementById(
			PASSWORD_INPUT_ID,
		) as HTMLInputElement | null;
		const messageEl = document.getElementById(MESSAGE_ID) as HTMLParagraphElement | null;
		const logoutBtn = document.getElementById(
			LOGOUT_BUTTON_ID,
		) as HTMLButtonElement | null;

		// Nếu đã login trước đó thì cập nhật UI
		if (window.localStorage.getItem(STORAGE_KEY) === 'true') {
			if (messageEl) {
				messageEl.textContent = getMessage('loggedIn');
				messageEl.classList.remove('error');
				messageEl.classList.add('success');
			}
			if (logoutBtn) {
				logoutBtn.hidden = false;
			}
		}

		form?.addEventListener('submit', (event) => {
			event.preventDefault();

			const username = usernameInput?.value.trim() ?? '';
			const password = passwordInput?.value ?? '';

			// Demo: tài khoản tĩnh ở client
			const VALID_USERNAME = 'admin';
			const VALID_PASSWORD = '1';

			if (username === VALID_USERNAME && password === VALID_PASSWORD) {
				window.localStorage.setItem(STORAGE_KEY, 'true');
				if (messageEl) {
					messageEl.textContent = getMessage('success');
					messageEl.classList.remove('error');
					messageEl.classList.add('success');
				}
				if (logoutBtn) {
					logoutBtn.hidden = false;
				}
			} else {
				if (messageEl) {
					messageEl.textContent = getMessage('error');
					messageEl.classList.remove('success');
					messageEl.classList.add('error');
				}
			}
		});

		logoutBtn?.addEventListener('click', () => {
			window.localStorage.removeItem(STORAGE_KEY);
			if (messageEl) {
				messageEl.textContent = getMessage('loggedOut');
				messageEl.classList.remove('success');
				messageEl.classList.remove('error');
			}
			if (logoutBtn) {
				logoutBtn.hidden = true;
			}
			if (usernameInput) usernameInput.value = '';
			if (passwordInput) passwordInput.value = '';
		});
	</script>

	<style>
		.page-header {
			display: grid;
			gap: 0.5rem;
			margin-bottom: 1.5rem;
		}
		.eyebrow {
			margin: 0;
			text-transform: uppercase;
			font-size: 0.9rem;
			letter-spacing: 0.15em;
			color: rgb(var(--gray));
		}
		.lead {
			margin: 0;
			color: rgb(var(--gray));
			max-width: 640px;
		}
		.card {
			display: grid;
			gap: 0.75rem;
			max-width: 380px;
			padding: 1.5rem 1.75rem;
			border-radius: 1rem;
			border: 1px solid rgba(var(--black), 0.06);
			box-shadow: 0 10px 25px rgba(var(--black), 0.04);
			background: white;
		}
		.actions {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		.field-group {
			display: grid;
			gap: 0.25rem;
		}
		label {
			font-weight: 500;
			font-size: 0.95rem;
		}
		input {
			padding: 0.6rem 0.75rem;
			border-radius: 0.6rem;
			border: 1px solid rgba(var(--black), 0.12);
			font-size: 1rem;
		}
		input:focus-visible {
			outline: 2px solid rgb(var(--accent));
			outline-offset: 1px;
		}
		.primary-btn {
			margin-top: 0.25rem;
			padding: 0.6rem 0.9rem;
			border-radius: 999px;
			border: none;
			background: rgb(var(--accent));
			color: white;
			font-weight: 600;
			cursor: pointer;
		}
		.primary-btn:hover {
			filter: brightness(0.95);
		}
		.secondary-btn {
			margin-top: 0.25rem;
			padding: 0.6rem 0.9rem;
			border-radius: 999px;
			border: 1px solid rgba(var(--black), 0.15);
			background: white;
			color: rgb(var(--black));
			font-weight: 500;
			cursor: pointer;
		}
		.secondary-btn:hover {
			background: rgba(var(--black), 0.02);
		}
		.message {
			min-height: 1.4rem;
			font-size: 0.9rem;
		}
		.message.error {
			color: #dc2626;
		}
		.message.success {
			color: #16a34a;
		}
		.hint {
			margin-top: 0.5rem;
			font-size: 0.85rem;
			color: rgb(var(--gray));
			max-width: 480px;
		}
	</style>
</PageLayout>

